---
title: "champs_reporter"
author: "Girls of Steel Scouting"
date: "2024-04-03"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = FALSE}
library(devtools)
load_all("../tbaR")
source("statbotics_readR.R")

event_code <- "2024gaalb"

registered_teams <- event_teams(event_code, keys = TRUE)
registered_teams <- as.numeric(
    substr(registered_teams, 4, nchar(registered_teams))
)

statbotics_data <- data.frame(t(sapply(registered_teams, read_team_year, year = 2024)))
```

```{r, message = FALSE, error = FALSE, warning = FALSE}
# gabriel's guided tour of historical matches

# fundamentally, we want to mitigate API risk by looking at historical matches
# as well as matches at the championship.

# @TODO gotta make better names for everything, but this is the code outline

# explain additional parameters through "..."
all_2024_matches <- sapply(registered_teams, team_matches, year = 2024)

# why are these not all the same?
sapply(all_2024_matches, ncol)

# answer: check this output (last column)
tmp <- merge(all_2024_matches[[4]], all_2024_matches[[1]], all = TRUE)

result <- all_2024_matches %>%
    reduce(full_join)

# do we need to trim possibly-duplicate rows (i.e. if two teams were in the same match?)
stopifnot(!any(duplicated(result)))

year_historical_matches <- function(event_code){
    registered_teams <- event_teams(event_code, keys = TRUE)
    registered_teams <- as.numeric(
        substr(registered_teams, 4, nchar(registered_teams))
    )
    year <- as.numeric(substr(event_code, 1, 4))
    matches <- sapply(registered_teams, team_matches, year = year)
    result <- matches %>%
        reduce(full_join)
    # check for duplicated matches
    stopifnot(!any(duplicated(result)))
    return(result)
}

data <- get_multifield_df(year_historical_matches("2024gaalb"), 
                          c("autoLine", "endGame"))

data$id <- as.numeric(
    substr(data$id, 4, nchar(data$id))
)

data <- data[data$id %in% registered_teams, ]

data <- merge(data, statbotics_data, by.x = "id", by.y = "team")
```

